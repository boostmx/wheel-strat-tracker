generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String      @id @default(cuid())
  firstName  String
  lastName   String
  email      String      @unique
  bio        String?
  avatarUrl  String?
  isAdmin    Boolean     @default(false)
  username   String      @unique
  password   String
  createdAt  DateTime    @default(now())
  portfolios Portfolio[]
}

model Portfolio {
  id                String     @id @default(cuid())
  name              String
  userId            String
  startingCapital   Decimal    @default(0)
  createdAt         DateTime   @default(now())
  additionalCapital Decimal    @default(0)
  notes             String?
  updatedAt         DateTime?  @updatedAt
  user              User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  trades            Trade[]
  stockLot          StockLot[]

  @@index([userId])
}

model Trade {
  id               String      @id @default(cuid())
  ticker           String
  strikePrice      Float
  expirationDate   DateTime
  type             TradeType
  contracts        Int
  contractPrice    Float
  entryPrice       Float?
  status           TradeStatus @default(open)
  closedAt         DateTime?
  closingPrice     Float?
  premiumCaptured  Float?
  percentPL        Float?
  portfolioId      String
  createdAt        DateTime    @default(now())
  notes            String?
  contractsInitial Int
  contractsOpen    Int
  portfolio        Portfolio   @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  stockLot         StockLot?   @relation(fields: [stockLotId], references: [id])
  stockLotId       String?
}

enum TradeType {
  Put
  Call
  CoveredCall
  CashSecuredPut
}

enum TradeStatus {
  open
  closed
}

enum CloseReason {
  manual
  expiredWorthless
  assigned
}

model StockLot {
  id          String    @id @default(cuid())
  portfolioId String
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  ticker  String
  shares  Int
  avgCost Decimal @db.Decimal(18, 6) // per-share cost basis

  status StockLotStatus @default(OPEN)

  openedAt DateTime  @default(now())
  closedAt DateTime?

  closePrice  Decimal? @db.Decimal(18, 6)
  realizedPnl Decimal? @db.Decimal(18, 2)

  notes String? // <-- NEW

  trades Trade[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sales StockLotSale[]

  @@index([portfolioId, ticker])
  @@index([portfolioId, status])
}

model StockLotSale {
  id         String           @id @default(cuid())
  stockLotId String
  stockLot   StockLot         @relation(fields: [stockLotId], references: [id], onDelete: Cascade)

  soldAt      DateTime        @default(now())
  sharesSold  Int
  salePrice   Decimal         @db.Decimal(18, 6) // per-share sale price
  fees        Decimal?        @db.Decimal(18, 2)
  realizedPnl Decimal         @db.Decimal(18, 2)

  source StockLotSaleSource   @default(manual)
  notes  String?

  createdAt DateTime          @default(now())

  @@index([stockLotId, soldAt])
}

enum StockLotStatus {
  OPEN
  CLOSED
}

enum StockLotSaleSource {
  manual
  assignment
}

